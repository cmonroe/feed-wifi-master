From 8cb06d601dff5b2728684f230ffe46d42e98cab3 Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Fri, 29 Mar 2024 14:55:41 +0800
Subject: [PATCH] mac80211: mtk: send 4 addr nullfunc after drv_event_callback

mt76 set channel in drv_event_callback and the 4 addr nullfunc may
be dropped. Send 4 addr nullfunc after drv_event_callback to avoid
this issue.

Signed-off-by: Peter Chiu <chui-hao.chiu@mediatek.com>

--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@ -5289,13 +5289,6 @@ static bool ieee80211_assoc_success(stru
 	ieee80211_set_associated(sdata, assoc_data, changed);
 
 	/*
-	 * If we're using 4-addr mode, let the AP know that we're
-	 * doing so, so that it can create the STA VLAN on its side
-	 */
-	if (ifmgd->use_4addr)
-		ieee80211_send_4addr_nullfunc(local, sdata);
-
-	/*
 	 * Start timer to probe the connection to the AP now.
 	 * Also start the timer that will detect beacon loss.
 	 */
@@ -5654,6 +5647,13 @@ static void ieee80211_handle_beacon_sig(
 		};
 
 		/*
+		* If we're using 4-addr mode, let the AP know that we're
+		* doing so, so that it can create the STA VLAN on its side
+		*/
+		if (ifmgd->use_4addr)
+			ieee80211_send_4addr_nullfunc(sdata->local, sdata);
+
+		/*
 		 * if signal crosses either of the boundaries, invoke callback
 		 * with appropriate parameters
 		 */
